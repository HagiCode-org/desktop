# 依赖安装进度对话框

## 状态: ExecutionCompleted

## 概述

创建一个通用的依赖安装进度对话框组件，为用户提供实时的安装进度反馈和详细的日志输出。该组件将统一目前分散在不同场景（首次使用引导、版本管理页面、依赖管理卡片）中的依赖安装体验。

## 问题陈述

### 用户体验问题

1. **缺乏透明度**：用户点击安装后无法看到执行过程，只能等待结果
2. **无实时反馈**：安装日志无法实时展示，用户不清楚当前进度
3. **多命令场景混乱**：当需要执行多个安装命令时，无法区分当前执行的是哪一个
4. **失败处理不明确**：安装失败后用户无法获取错误详情进行排查

### 技术问题

1. **代码重复**：不同场景下的安装逻辑各自实现，缺乏统一封装
2. **回调处理分散**：安装成功/失败后的回调逻辑散落在各处
3. **命令执行管理缺失**：缺少统一的命令执行、日志收集和状态管理机制

## 解决方案

### 核心组件

创建 `DependencyInstallProgressDialog` 组件，具备以下特性：

#### 功能特性

1. **实时日志展示**
   - 使用 IPC 通信从主进程接收命令输出
   - 滚动显示安装日志，最新日志自动滚动到可见区域
   - 支持日志级别分类（info、error、warning）

2. **命令执行显示**
   - 显示当前执行的命令
   - 多命令场景下显示进度指示（如 "正在执行命令 1/3"）
   - 已完成命令标记为完成状态

3. **状态反馈**
   - 安装中：显示进度动画或加载指示器
   - 安装成功：显示成功图标和完成提示
   - 安装失败：显示错误图标、失败原因和错误日志

4. **用户操作**
   - 安装过程中禁用关闭按钮（或提供取消选项）
   - 安装完成后提供关闭按钮
   - 失败时提供重试选项

#### 技术实现

```typescript
// 组件接口
interface DependencyInstallProgressDialogProps {
  isOpen: boolean;
  commands: string[];           // 要执行的命令数组
  onClose: () => void;
  onSuccess?: () => void;       // 安装成功回调
  onFailure?: (error: string) => void;  // 安装失败回调
  title?: string;               // 对话框标题
  workingDirectory?: string;    // 命令执行目录
}

// 主进程 IPC 处理
interface InstallProgressMessage {
  type: 'command-start' | 'command-output' | 'command-complete' | 'install-complete' | 'install-error';
  commandIndex: number;
  totalCommands: number;
  output?: string;
  error?: string;
}
```

### 应用场景

1. **首次使用引导（Onboarding）**
   - 在向导的依赖安装步骤中显示进度

2. **版本管理页面**
   - 用户手动触发依赖安装时显示进度

3. **依赖管理卡片**
   - 统一依赖管理组件中的安装操作

## 影响分析

### 用户体验改进

1. **透明度提升**：用户可实时看到安装过程和日志输出
2. **信心增强**：明确的进度指示减少用户焦虑
3. **问题诊断**：失败时提供详细错误信息便于排查

### 代码质量改进

1. **代码复用**：统一的安装对话框组件消除重复代码
2. **可维护性**：集中管理安装逻辑，便于后续优化
3. **可测试性**：独立组件便于单元测试和集成测试

### 架构一致性

1. **符合项目约定**：使用 shadcn/ui 的 Dialog 组件保持 UI 一致性
2. **遵循 IPC 模式**：符合项目定义的主进程与渲染进程通信模式
3. **集成状态管理**：与 Redux Toolkit 状态管理无缝集成

## 实施范围

### 主要变更

1. **新增组件**
   - `src/renderer/components/DependencyInstallProgressDialog.tsx`

2. **主进程修改**
   - `src/main/dependency-manager.ts` - 增强命令执行以支持实时输出
   - `src/main/main.ts` - 添加新的 IPC 处理器

3. **状态管理更新**
   - `src/renderer/store/slices/dependencySlice.ts` - 扩展状态以支持详细日志
   - `src/renderer/store/sagas/dependencySaga.ts` - 更新 saga 以处理新的进度事件

4. **国际化**
   - `src/renderer/i18n/locales/en-US/pages.json`
   - `src/renderer/i18n/locales/zh-CN/pages.json`

### 不包含在范围内

- 依赖安装逻辑本身的修改（仅增强输出收集）
- 现有依赖管理 UI 的重构
- 命令执行机制的完全重写

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| IPC 通道命名冲突 | 中 | 使用新的、描述性的通道名称 |
| 现有安装流程中断 | 高 | 保持向后兼容，渐进式迁移 |
| UI 性能问题（大量日志） | 中 | 实现日志滚动和数量限制 |
| 国际化覆盖不完整 | 低 | 优先实现中英文，后续扩展 |

## 成功标准

1. **功能完整性**
   - 对话框能正确显示安装进度
   - 实时日志输出正常工作
   - 成功/失败状态正确显示

2. **用户体验**
   - 对话框在所有三个场景中一致工作
   - 用户可以在失败时重试安装
   - 错误信息清晰易懂

3. **代码质量**
   - 组件通过 ESLint 和 TypeScript 检查
   - 新增代码有适当的类型定义
   - 遵循项目现有的代码风格

## 后续工作

1. 收集用户反馈，迭代优化 UI
2. 考虑添加日志导出功能
3. 评估是否需要支持取消长时间运行的安装命令
